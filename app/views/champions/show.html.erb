
<div class="row">
  <div class="hidden-xs col-md-2">&nbsp;</div>
  <div class="col-xs-12 col-md-8">
    <h3>
      <a href="<%= book_path(@champion.book.summoner_id) %>">
        <%= @champion.book.summoner_name %></a>'s <%= @champion.static_data.name  %>
    </h3>
    <p class="title">"<%= @champion.static_data.title %>"</p>
  </div>
  <div class="hidden-xs col-md-2">&nbsp;</div>
  <div class="hidden-xs col-sm-2 col-md-3">&nbsp;</div>
  <div class="col-xs-12 col-sm-4 col-md-3">
    <img
      class="portrait"
      src="<%= @champion.static_data.splash_url %>"
      alt="<%= @champion.static_data.name %> <%= @champion.champion_id %>"
    >
  </div>
  <div class="col-xs-12 col-sm-4 col-md-3">
    <div class="info">
      <p class="school-level"><%= @champion.school_level %><span class="pull-right"><%= @champion.mastery_title %></span></p>
      <% if @champion.chest_earned %>
      <p class="honors"><span class="glyphicon glyphicon-star"></span> Honor Role*</p>
      <% end %>
      <p>Highest Grade Earned: <%= @champion.highest_grade %></p>
      <p>Mastery Points: <%= @champion.mastery_points %></p>
    </div>
  </div>
  <% if @champion.chest_earned %>
  <div class="col-xs-12">
    <div class="asterisk">*Chest Earned</div>
  </div>
  <% end %>
</div>

<%= render partial: "comments/comments", locals: {comments: @champion.comments.paginate(page: params[:page])} %>

<script>
$(function() {
  if ($('#infinite-scrolling').size() > 0){
    $(window).on('scroll', function(){
      var morePostsUrl = $('.pagination a.next_page').attr('href')
      if (morePostsUrl && $(window).scrollTop() > $(document).height() - $(window).height() - 5){
        $('.pagination').html("<span class='glyphicon glyphicon-refresh spinning'></span>");
        $.getScript(morePostsUrl);
      }
    });
  }


  $( "form.comment-form").submit(function(e) {
    console.log("Submit button clicked");
    e.preventDefault();
    var text = $.trim($('textarea[name=commentText]').val());
    if (!text) {
      console.log("No content");
      return;
    }
    var comment = {
      'text': text,
      'id': <%= @champion.id %>
    };
    var data = {
      "comment": comment
    };
    $.ajax({
      type: "POST",
      url: "<%= new_champion_comment_path %>",
      data: data,
      dataType: 'script',
      encode: true,
      success: function( result ) {
        console.log("SUCCESS");
        clearForm();
      },
      error: function( error ) {
        console.log("ERROR");
        var message = error.responseText;
        console.log(message);
      }
    });
  });

  $( ".comments-list").on("click", "input.delete-btn", function(e) {
    e.preventDefault();
    console.log("Delete button clicked");
    var result = window.confirm("Are you sure you want to delete this note?");
    if (!result){
      return;
    }
    var commentId = $(e.target)[0].dataset.id;
    var comment = {
      'id': commentId
    };
    var data = {
      "comment": comment
    };
    $.ajax({
      type: "DELETE",
      url: "<%= delete_comment_path %>",
      data: data,
      dataType: 'json',
      encode: true,
      success: function( result ) {
        console.log("SUCCESS");
        removeComment(result);
      },
      error: function( error ) {
        console.log("ERROR");
        var message = error.responseText;
        console.log(message);
      }
    });
  });

  var clearForm = function(){
    $('textarea[name=commentText]').val("");
  };

  var removeComment = function(comment){
    console.log("removing comment");
    $("#comment-"+comment.id).remove();
  };
});
</script>
